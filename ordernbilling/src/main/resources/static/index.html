<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order & Billing — Console</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />

  <!-- TypeScript compiler (browser) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/typescript/5.3.3/typescript.min.js"></script>

  <style>
    :root {
      --bg:        #f5f4f0;
      --surface:   #ffffff;
      --border:    #e0ddd7;
      --accent:    #2563eb;
      --accent2:   #f97316;
      --muted:     #9ca3af;
      --text:      #1a1a2e;
      --text-dim:  #6b7280;
      --danger:    #ef4444;
      --success:   #16a34a;
      --radius:    4px;
      --mono:      'Space Mono', monospace;
      --display:   'Bebas Neue', sans-serif;
      --body:      'Lato', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--body);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ─── NOISE TEXTURE ─────────────────────────────────── */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.025'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 0;
    }

    /* ─── HEADER ────────────────────────────────────────── */
    header {
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
      background: rgba(245,244,240,0.92);
      backdrop-filter: blur(12px);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 40px; height: 64px;
    }

    .logo {
      font-family: var(--display);
      font-size: 26px; letter-spacing: 0.06em;
      color: var(--text);
    }
    .logo span { color: var(--accent); }

    .header-status {
      display: flex; align-items: center; gap: 10px;
      font-family: var(--mono); font-size: 11px; color: var(--muted);
      letter-spacing: 0.1em;
    }
    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
      animation: pulse 2.4s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50%       { opacity: 0.6; transform: scale(0.85); }
    }

    /* ─── TABS ──────────────────────────────────────────── */
    nav {
      display: flex;
      border-bottom: 1px solid var(--border);
      padding: 0 40px;
      background: var(--bg);
    }

    .tab {
      background: none; border: none;
      padding: 16px 22px;
      font-family: var(--mono); font-size: 11px;
      letter-spacing: 0.12em; text-transform: uppercase;
      color: var(--muted); cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: color 0.15s, border-color 0.15s;
      display: flex; align-items: center; gap: 8px;
    }
    .tab.active { color: var(--text); border-bottom-color: var(--accent); }
    .tab:hover:not(.active) { color: var(--text-dim); }
    .tab-icon { font-size: 14px; }

    /* ─── LAYOUT ────────────────────────────────────────── */
    main {
      position: relative; z-index: 1;
      padding: 36px 40px; max-width: 1140px;
    }

    .panel { display: none; animation: fadein 0.2s ease; }
    .panel.active { display: grid; }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .two-col { grid-template-columns: 1fr 1fr; gap: 24px; }
    .two-col-wide { grid-template-columns: 1.25fr 1fr; gap: 24px; }

    /* ─── CARDS ─────────────────────────────────────────── */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
    }

    .card-title {
      font-family: var(--mono); font-size: 10px;
      letter-spacing: 0.18em; text-transform: uppercase;
      color: var(--muted); margin-bottom: 20px;
      padding-bottom: 12px; border-bottom: 1px solid var(--border);
    }

    /* ─── FORM ELEMENTS ─────────────────────────────────── */
    .field { margin-bottom: 16px; }

    .field label {
      display: block;
      font-family: var(--mono); font-size: 10px;
      letter-spacing: 0.12em; text-transform: uppercase;
      color: var(--text-dim); margin-bottom: 7px;
    }

    .field input, .field select {
      width: 100%;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px; color: var(--text);
      font-family: var(--mono); font-size: 13px;
      outline: none; transition: border-color 0.15s;
      appearance: none; -webkit-appearance: none;
    }
    .field input::placeholder { color: var(--muted); }
    .field input:focus, .field select:focus { border-color: var(--accent); }
    .field select { color: var(--text-dim); }
    .field select.filled { color: var(--text); }

    /* ─── BUTTONS ───────────────────────────────────────── */
    .btn {
      display: inline-flex; align-items: center; gap: 7px;
      padding: 10px 20px;
      font-family: var(--mono); font-size: 11px;
      letter-spacing: 0.1em; text-transform: uppercase;
      border: none; border-radius: var(--radius);
      cursor: pointer; transition: opacity 0.15s, transform 0.1s;
      white-space: nowrap;
    }
    .btn:hover:not(:disabled) { opacity: 0.82; }
    .btn:active:not(:disabled) { transform: scale(0.97); }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }

    .btn-primary { background: var(--accent); color: #fff; font-weight: 700; }
    .btn-danger  { background: var(--danger); color: #fff; }
    .btn-ghost   {
      background: transparent; color: var(--muted);
      border: 1px solid var(--border);
    }
    .btn-ghost:hover:not(:disabled) { color: var(--text); border-color: var(--text-dim); opacity: 1; }
    .btn-sm { padding: 7px 13px; font-size: 10px; }

    /* ─── LIST ITEMS ────────────────────────────────────── */
    .list { display: flex; flex-direction: column; gap: 8px; }

    .list-item {
      background: var(--bg);
      border: 1px solid var(--border); border-radius: var(--radius);
      padding: 12px 14px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .list-item-left { display: flex; flex-direction: column; gap: 3px; }
    .list-item-name {
      font-family: var(--mono); font-size: 13px; color: var(--text);
    }
    .list-item-sub {
      font-family: var(--mono); font-size: 11px; color: var(--muted);
    }
    .id-badge {
      color: var(--muted); margin-right: 8px; font-size: 11px;
    }

    /* ─── BADGE ─────────────────────────────────────────── */
    .badge {
      display: inline-block;
      padding: 3px 9px; border-radius: 3px;
      font-family: var(--mono); font-size: 10px;
      letter-spacing: 0.08em; text-transform: uppercase;
    }
    .badge-green  { background: #dcfce7; color: var(--success); border: 1px solid #bbf7d0; }
    .badge-yellow { background: #fef3c7; color: #92400e;       border: 1px solid #fde68a; }
    .badge-accent { background: #dbeafe; color: var(--accent);  border: 1px solid #bfdbfe; }

    /* ─── EMPTY STATE ───────────────────────────────────── */
    .empty {
      text-align: center; padding: 40px 0;
      font-family: var(--mono); font-size: 12px;
      color: var(--border); letter-spacing: 0.08em;
    }

    /* ─── DIVIDER ───────────────────────────────────────── */
    .divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

    /* ─── ORDER ITEMS BUILDER ───────────────────────────── */
    .order-row {
      display: flex; gap: 8px; align-items: center; margin-bottom: 8px;
    }
    .order-row select {
      flex: 2; background: var(--bg); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 9px 10px;
      color: var(--muted); font-family: var(--mono); font-size: 12px;
      outline: none; appearance: none;
    }
    .order-row select.filled { color: var(--text); }
    .order-row select:focus { border-color: var(--accent); }
    .order-row input {
      flex: 1; background: var(--bg); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 9px 10px;
      color: var(--text); font-family: var(--mono); font-size: 12px;
      outline: none;
    }
    .order-row input:focus { border-color: var(--accent); }

    /* ─── SUMMARY ROW ───────────────────────────────────── */
    .summary-row {
      display: flex; justify-content: space-between;
      font-family: var(--mono); font-size: 12px;
      color: var(--muted); margin-bottom: 6px;
    }
    .summary-row .value { color: var(--text); }

    /* ─── ORDER RESULT ──────────────────────────────────── */
    .order-result-id {
      font-family: var(--display); font-size: 40px; letter-spacing: 0.05em;
      color: var(--text); line-height: 1; margin-bottom: 6px;
    }
    .order-result-total {
      font-family: var(--display); font-size: 28px;
      color: var(--accent); margin-bottom: 12px;
    }
    .order-item-row {
      display: flex; justify-content: space-between;
      font-family: var(--mono); font-size: 12px;
      color: var(--text-dim); padding: 7px 0;
      border-bottom: 1px solid var(--border);
    }

    /* ─── TOAST ─────────────────────────────────────────── */
    #toast {
      position: fixed; bottom: 32px; right: 32px;
      padding: 13px 20px; border-radius: var(--radius);
      font-family: var(--mono); font-size: 12px;
      letter-spacing: 0.06em; z-index: 9999;
      max-width: 360px; pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      opacity: 0; transform: translateY(12px);
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.success { background: var(--success); color: #fff; }
    #toast.error   { background: var(--danger);  color: #fff; }

    /* ─── BALANCE HERO ──────────────────────────────────── */
    .balance-hero {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px;
    }
    .balance-hero-label {
      font-family: var(--mono); font-size: 10px;
      letter-spacing: 0.12em; text-transform: uppercase;
      color: var(--muted);
    }
    .balance-hero-value {
      font-family: var(--display); font-size: 32px;
      color: var(--accent); letter-spacing: 0.04em;
    }

    /* ─── PRODUCT ACTIONS ───────────────────────────────── */
    .product-actions { display: flex; gap: 6px; align-items: center; }
    .inline-edit {
      display: flex; gap: 6px; align-items: center; margin-top: 10px;
    }
    .inline-edit input {
      width: 100px; background: var(--bg);
      border: 1px solid var(--accent);
      border-radius: var(--radius);
      padding: 7px 10px; color: var(--text);
      font-family: var(--mono); font-size: 12px; outline: none;
    }

    /* ─── SCROLLBAR ─────────────────────────────────────── */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    @media (max-width: 720px) {
      header, nav { padding: 0 16px; }
      main { padding: 20px 16px; }
      .two-col, .two-col-wide { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">ORDER<span>&amp;</span>BILLING</div>
    <div class="header-status">
      <div class="status-dot"></div>
      <span>localhost:8080</span>
    </div>
  </header>

  <nav id="tabs">
    <button class="tab active" data-tab="users"><span class="tab-icon">◈</span>Users</button>
    <button class="tab" data-tab="products"><span class="tab-icon">◉</span>Products</button>
    <button class="tab" data-tab="orders"><span class="tab-icon">◆</span>Orders</button>
    <button class="tab" data-tab="balance"><span class="tab-icon">◇</span>Balance</button>
  </nav>

  <main>

    <!-- USERS -->
    <div class="panel active two-col" id="panel-users">
      <div class="card">
        <div class="card-title">Create User</div>
        <div class="field"><label>Username</label><input id="u-name" type="text" placeholder="e.g. alice" /></div>
        <div class="field"><label>Password (min 8 chars)</label><input id="u-pass" type="password" placeholder="••••••••" /></div>
        <div class="field"><label>Email</label><input id="u-email" type="email" placeholder="alice@example.com" /></div>
        <div class="field"><label>Starting Balance ($)</label><input id="u-bal" type="number" placeholder="1000" min="0" /></div>
        <button class="btn btn-primary" id="btn-create-user">+ Create User</button>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <div class="card-title" style="margin:0;border:none;padding:0;">All Users</div>
          <button class="btn btn-ghost btn-sm" id="btn-refresh-users">↻ Refresh</button>
        </div>
        <div class="list" id="users-list"><div class="empty">No users yet</div></div>
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="panel two-col-wide" id="panel-products">
      <div class="card">
        <div class="card-title">Add Product</div>
        <div class="field"><label>Product Name</label><input id="p-name" type="text" placeholder="e.g. Mechanical Keyboard" /></div>
        <div class="field"><label>Stock Quantity</label><input id="p-qty" type="number" placeholder="10" min="1" /></div>
        <div class="field"><label>Price ($)</label><input id="p-price" type="number" placeholder="149" min="0" /></div>
        <button class="btn btn-primary" id="btn-create-product">+ Add Product</button>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <div class="card-title" style="margin:0;border:none;padding:0;">Product Catalog</div>
          <button class="btn btn-ghost btn-sm" id="btn-refresh-products">↻ Refresh</button>
        </div>
        <div class="list" id="products-list"><div class="empty">No products yet</div></div>
      </div>
    </div>

    <!-- ORDERS -->
    <div class="panel two-col-wide" id="panel-orders">
      <div class="card">
        <div class="card-title">Place Order</div>
        <div class="field">
          <label>Select User</label>
          <select id="o-user" class="field"><option value="">-- choose user --</option></select>
        </div>
        <div class="field">
          <label>Order Items</label>
          <div id="order-items-builder"></div>
          <button class="btn btn-ghost btn-sm" id="btn-add-item" style="margin-top:8px;">+ Add Item</button>
        </div>
        <hr class="divider" />
        <div class="summary-row"><span>Estimated Total</span><span class="value" id="est-total">$0</span></div>
        <div class="summary-row" id="user-bal-row" style="display:none;"><span>User Balance</span><span class="value" id="user-bal-display">—</span></div>
        <hr class="divider" />
        <button class="btn btn-primary" id="btn-place-order">Place Order →</button>
      </div>
      <div class="card">
        <div class="card-title">Last Order Result</div>
        <div id="order-result"><div class="empty">No order placed yet</div></div>
      </div>
    </div>

    <!-- BALANCE -->
    <div class="panel two-col" id="panel-balance">
      <div class="card">
        <div class="card-title">Manage Balance</div>
        <div class="field">
          <label>Select User</label>
          <select id="b-user"><option value="">-- choose user --</option></select>
        </div>
        <div id="balance-hero-container"></div>
        <div class="field"><label>Amount ($)</label><input id="b-amount" type="number" placeholder="e.g. 500" min="1" /></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-primary" id="btn-deposit">+ Deposit</button>
          <button class="btn btn-danger" id="btn-withdraw">− Withdraw</button>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <div class="card-title" style="margin:0;border:none;padding:0;">User Balances</div>
          <button class="btn btn-ghost btn-sm" id="btn-refresh-balances">↻ Refresh</button>
        </div>
        <div class="list" id="balance-list"><div class="empty">No users</div></div>
      </div>
    </div>

  </main>

  <div id="toast"></div>

  <!-- TypeScript source (transpiled at runtime) -->
  <script id="ts-src" type="text/typescript">
    // ─── TYPES ───────────────────────────────────────────────────────────────────
    interface User {
      id: number;
      username: string;
      email: string;
      accountBalance: number;
    }

    interface Product {
      id: number;
      name: string;
      amount: number;
      price: number;
    }

    interface OrderItemDTO {
      productId: number;
      quantity: number;
    }

    interface OrderItemResult {
      product: { id: number; name: string };
      quantity: number;
      priceAtPurchase: number;
    }

    interface OrderResult {
      id: number;
      orderTotal: number;
      status: string;
      items: OrderItemResult[];
    }

    interface OrderRow {
      productId: string;
      quantity: string;
    }

    // ─── API HELPER ───────────────────────────────────────────────────────────────
    async function api<T>(method: string, path: string, body?: unknown): Promise<T> {
      const res = await fetch(path, {
        method,
        headers: { "Content-Type": "application/json" },
        body: body ? JSON.stringify(body) : undefined,
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({})) as { message?: string };
        throw new Error(err.message || `HTTP ${res.status}`);
      }
      return res.json().catch(() => null) as Promise<T>;
    }

    // ─── TOAST ────────────────────────────────────────────────────────────────────
    let toastTimer: ReturnType<typeof setTimeout> | null = null;

    function toast(msg: string, type: "success" | "error" = "success"): void {
      const el = document.getElementById("toast")!;
      el.textContent = msg;
      el.className = `show ${type}`;
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.remove("show"), 3500);
    }

    // ─── UTILITIES ────────────────────────────────────────────────────────────────
    const $el = <T extends HTMLElement>(id: string): T => document.getElementById(id) as T;
    const $val = (id: string): string => ($el<HTMLInputElement>(id)).value.trim();
    const $dis = (id: string, v: boolean): void => { ($el<HTMLButtonElement>(id)).disabled = v; };

    // ─── STATE ────────────────────────────────────────────────────────────────────
    let users: User[] = [];
    let products: Product[] = [];
    let orderRows: OrderRow[] = [{ productId: "", quantity: "" }];
    let editingProductId: number | null = null;

    // ─── TABS ─────────────────────────────────────────────────────────────────────
    document.querySelectorAll<HTMLButtonElement>(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(`panel-${tab.dataset.tab}`)?.classList.add("active");
      });
    });

    // ─── USERS ────────────────────────────────────────────────────────────────────
    async function loadUsers(): Promise<void> {
      try {
        users = await api<User[]>("GET", "/user/all");
        renderUsers();
        syncUserDropdowns();
      } catch (e: unknown) {
        toast((e as Error).message, "error");
      }
    }

    function renderUsers(): void {
      const el = $el("users-list");
      if (!users.length) { el.innerHTML = '<div class="empty">No users yet</div>'; return; }
      el.innerHTML = users.map(u => `
        <div class="list-item">
          <div class="list-item-left">
            <div class="list-item-name"><span class="id-badge">#${u.id}</span>${escHtml(u.username)}</div>
            <div class="list-item-sub">${escHtml(u.email ?? "—")}</div>
          </div>
          <span class="badge badge-green">$${u.accountBalance}</span>
        </div>
      `).join("");
    }

    function syncUserDropdowns(): void {
      const opts = '<option value="">-- choose user --</option>' +
        users.map(u => `<option value="${u.id}">#${u.id} ${escHtml(u.username)} ($${u.accountBalance})</option>`).join("");
      $el<HTMLSelectElement>("o-user").innerHTML = opts;
      $el<HTMLSelectElement>("b-user").innerHTML = opts;
      renderBalanceList();
    }

    $el("btn-create-user").addEventListener("click", async () => {
      $dis("btn-create-user", true);
      try {
        const name = $val("u-name");
        await api<User>("POST", "/user/add", {
          username: name,
          password: $val("u-pass"),
          email: $val("u-email"),
          accountBalance: Number($val("u-bal")),
        });
        toast(`User "${name}" created ✓`);
        ["u-name","u-pass","u-email","u-bal"].forEach(id => ($el<HTMLInputElement>(id)).value = "");
        await loadUsers();
      } catch (e: unknown) { toast((e as Error).message, "error"); }
      $dis("btn-create-user", false);
    });

    $el("btn-refresh-users").addEventListener("click", loadUsers);

    // ─── PRODUCTS ─────────────────────────────────────────────────────────────────
    async function loadProducts(): Promise<void> {
      try {
        products = await api<Product[]>("GET", "/product/all");
        renderProducts();
        renderOrderBuilder();
      } catch (e: unknown) { toast((e as Error).message, "error"); }
    }

    function renderProducts(): void {
      const el = $el("products-list");
      if (!products.length) { el.innerHTML = '<div class="empty">No products yet</div>'; return; }
      el.innerHTML = products.map(p => `
        <div class="list-item" style="flex-direction:column;align-items:stretch;" id="prod-row-${p.id}">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="list-item-left">
              <div class="list-item-name"><span class="id-badge">#${p.id}</span>${escHtml(p.name)}</div>
              <div class="list-item-sub">stock: ${p.amount}</div>
            </div>
            <div class="product-actions">
              <span class="badge badge-yellow">$${p.price}</span>
              <button class="btn btn-ghost btn-sm" onclick="startEditPrice(${p.id},${p.price})">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">✕</button>
            </div>
          </div>
          <div class="inline-edit" id="edit-${p.id}" style="display:none;">
            <input type="number" id="edit-inp-${p.id}" value="${p.price}" />
            <button class="btn btn-primary btn-sm" onclick="savePrice(${p.id})">Save</button>
            <button class="btn btn-ghost btn-sm" onclick="cancelEdit(${p.id})">Cancel</button>
          </div>
        </div>
      `).join("");
    }

    function startEditPrice(id: number, price: number): void {
      if (editingProductId !== null) cancelEdit(editingProductId);
      editingProductId = id;
      const row = document.getElementById(`edit-${id}`)!;
      row.style.display = "flex";
      const inp = $el<HTMLInputElement>(`edit-inp-${id}`);
      inp.value = String(price);
      inp.focus();
    }

    function cancelEdit(id: number): void {
      const row = document.getElementById(`edit-${id}`);
      if (row) row.style.display = "none";
      editingProductId = null;
    }

    async function savePrice(id: number): Promise<void> {
      const newPrice = $el<HTMLInputElement>(`edit-inp-${id}`).value;
      try {
        await api("PUT", `/product/${id}/updateprice/${newPrice}`);
        toast("Price updated ✓");
        editingProductId = null;
        await loadProducts();
      } catch (e: unknown) { toast((e as Error).message, "error"); }
    }

    async function deleteProduct(id: number): Promise<void> {
      try {
        await api("DELETE", `/product/delete/${id}`);
        toast("Product deleted ✓");
        await loadProducts();
      } catch (e: unknown) { toast((e as Error).message, "error"); }
    }

    // expose for inline onclick
    const W = window as Record<string, unknown>;
    W.startEditPrice = startEditPrice;
    W.cancelEdit = cancelEdit;
    W.savePrice = savePrice;
    W.deleteProduct = deleteProduct;

    $el("btn-create-product").addEventListener("click", async () => {
      $dis("btn-create-product", true);
      try {
        const name = $val("p-name");
        await api<Product>("POST", "/product/add", {
          name,
          amount: Number($val("p-qty")),
          price:  Number($val("p-price")),
        });
        toast(`Product "${name}" added ✓`);
        ["p-name","p-qty","p-price"].forEach(id => ($el<HTMLInputElement>(id)).value = "");
        await loadProducts();
      } catch (e: unknown) { toast((e as Error).message, "error"); }
      $dis("btn-create-product", false);
    });

    $el("btn-refresh-products").addEventListener("click", loadProducts);

    // ─── ORDERS ───────────────────────────────────────────────────────────────────
    function renderOrderBuilder(): void {
      const container = $el("order-items-builder");
      container.innerHTML = orderRows.map((row, i) => `
        <div class="order-row">
          <select id="or-prod-${i}" class="${row.productId ? "filled" : ""}"
            onchange="updateOrderRow(${i},'productId',this.value)">
            <option value="">-- product --</option>
            ${products.map(p =>
              `<option value="${p.id}" ${p.id === Number(row.productId) ? "selected" : ""}>${escHtml(p.name)} ($${p.price})</option>`
            ).join("")}
          </select>
          <input type="number" value="${row.quantity}" placeholder="qty" min="1"
            oninput="updateOrderRow(${i},'quantity',this.value)" />
          ${orderRows.length > 1
            ? `<button class="btn btn-danger btn-sm" onclick="removeOrderRow(${i})">✕</button>`
            : ""}
        </div>
      `).join("");
      recalcTotal();
    }

    function updateOrderRow(i: number, field: keyof OrderRow, value: string): void {
      orderRows[i][field] = value;
      const sel = document.getElementById(`or-prod-${i}`) as HTMLSelectElement | null;
      if (sel) sel.className = value ? "filled" : "";
      recalcTotal();
    }

    function removeOrderRow(i: number): void {
      orderRows.splice(i, 1);
      renderOrderBuilder();
    }

    W.updateOrderRow = updateOrderRow;
    W.removeOrderRow = removeOrderRow;

    function recalcTotal(): void {
      const total = orderRows.reduce((sum, row) => {
        const p = products.find(pr => pr.id === Number(row.productId));
        return sum + (p ? p.price * (Number(row.quantity) || 0) : 0);
      }, 0);
      const totalEl = $el("est-total");
      totalEl.textContent = `$${total}`;
      totalEl.style.color = total > 0 ? "var(--accent)" : "var(--muted)";

      const userId = $el<HTMLSelectElement>("o-user").value;
      const user = users.find(u => u.id === Number(userId));
      const balRow = $el("user-bal-row");
      if (user) {
        balRow.style.display = "flex";
        const bd = $el("user-bal-display");
        bd.textContent = `$${user.accountBalance}`;
        bd.style.color = user.accountBalance >= total ? "var(--success)" : "var(--danger)";
      } else {
        balRow.style.display = "none";
      }
    }

    $el("o-user").addEventListener("change", recalcTotal);

    $el("btn-add-item").addEventListener("click", () => {
      orderRows.push({ productId: "", quantity: "" });
      renderOrderBuilder();
    });

    $el("btn-place-order").addEventListener("click", async () => {
      const userId = $el<HTMLSelectElement>("o-user").value;
      if (!userId) { toast("Select a user", "error"); return; }
      const valid = orderRows.filter(r => r.productId && r.quantity);
      if (!valid.length) { toast("Add at least one item with qty", "error"); return; }

      $dis("btn-place-order", true);
      try {
        const items: OrderItemDTO[] = valid.map(r => ({
          productId: Number(r.productId),
          quantity: Number(r.quantity),
        }));
        const order = await api<OrderResult>("POST", `/order/add/${userId}`, { items });
        toast(`Order #${order?.id} placed ✓`);
        renderOrderResult(order);
        orderRows = [{ productId: "", quantity: "" }];
        renderOrderBuilder();
        await loadUsers();
      } catch (e: unknown) { toast((e as Error).message, "error"); }
      $dis("btn-place-order", false);
    });

    function renderOrderResult(order: OrderResult): void {
      const accentColor = "var(--accent2)";
      $el("order-result").innerHTML = `
        <div class="order-result-id">ORDER #${order.id}</div>
        <div class="order-result-total">$${order.orderTotal}</div>
        <span class="badge" style="background:${accentColor}22;color:${accentColor};border:1px solid ${accentColor}44;display:inline-block;margin-bottom:16px;">
          ${order.status ?? "PENDING"}
        </span>
        ${order.items?.length ? `
          <div style="font-family:var(--mono);font-size:10px;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;margin:12px 0 8px;">Items</div>
          ${order.items.map(item => `
            <div class="order-item-row">
              <span>${escHtml(item.product?.name ?? `#${item.product?.id}`)} × ${item.quantity}</span>
              <span>$${item.priceAtPurchase}</span>
            </div>
          `).join("")}
        ` : ""}
      `;
    }

    // ─── BALANCE ──────────────────────────────────────────────────────────────────
    $el<HTMLSelectElement>("b-user").addEventListener("change", function() {
      const user = users.find(u => u.id === Number(this.value)) ?? null;
      renderBalanceHero(user);
      renderBalanceList();
    });

    function renderBalanceHero(user: User | null): void {
      $el("balance-hero-container").innerHTML = user ? `
        <div class="balance-hero">
          <span class="balance-hero-label">Current Balance</span>
          <span class="balance-hero-value">$${user.accountBalance}</span>
        </div>
      ` : "";
    }

    function renderBalanceList(): void {
      const el = $el("balance-list");
      if (!users.length) { el.innerHTML = '<div class="empty">No users</div>'; return; }
      const selectedId = Number($el<HTMLSelectElement>("b-user").value);
      el.innerHTML = users.map(u => `
        <div class="list-item" style="cursor:pointer;
          background:${u.id === selectedId ? "#dbeafe" : "var(--bg)"};
          border-color:${u.id === selectedId ? "var(--accent)" : "var(--border)"};"
          onclick="selectBalanceUser(${u.id})">
          <span class="list-item-name"><span class="id-badge">#${u.id}</span>${escHtml(u.username)}</span>
          <span style="font-family:var(--display);font-size:20px;
            color:${u.accountBalance > 0 ? "var(--accent)" : "var(--danger)"};">$${u.accountBalance}</span>
        </div>
      `).join("");
    }

    function selectBalanceUser(id: number): void {
      $el<HTMLSelectElement>("b-user").value = String(id);
      const user = users.find(u => u.id === id) ?? null;
      renderBalanceHero(user);
      renderBalanceList();
    }
    W.selectBalanceUser = selectBalanceUser;

    async function handleBalance(direction: "add" | "delete"): Promise<void> {
      const userId = $el<HTMLSelectElement>("b-user").value;
      const amount = $val("b-amount");
      if (!userId || !amount) { toast("Select user and enter amount", "error"); return; }
      $dis("btn-deposit", true); $dis("btn-withdraw", true);
      try {
        await api("PUT", `/user/${userId}/${direction}balance/${amount}`);
        toast(direction === "add" ? `+$${amount} deposited ✓` : `-$${amount} withdrawn ✓`);
        ($el<HTMLInputElement>("b-amount")).value = "";
        await loadUsers();
        const user = users.find(u => u.id === Number(userId)) ?? null;
        renderBalanceHero(user);
      } catch (e: unknown) { toast((e as Error).message, "error"); }
      $dis("btn-deposit", false); $dis("btn-withdraw", false);
    }

    $el("btn-deposit").addEventListener("click",  () => handleBalance("add"));
    $el("btn-withdraw").addEventListener("click", () => handleBalance("delete"));
    $el("btn-refresh-balances").addEventListener("click", async () => { await loadUsers(); renderBalanceList(); });

    // ─── ESCAPE HTML ──────────────────────────────────────────────────────────────
    function escHtml(str: string): string {
      return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    // ─── BOOT ─────────────────────────────────────────────────────────────────────
    (async () => {
      await Promise.allSettled([loadUsers(), loadProducts()]);
    })();
  </script>

  <!-- TS → JS transpiler bootstrap -->
  <script>
    (function () {
      const src = document.getElementById("ts-src").textContent;
      const result = ts.transpileModule(src, {
        compilerOptions: { target: ts.ScriptTarget.ES2017, strict: false }
      });
      const s = document.createElement("script");
      s.textContent = result.outputText;
      document.body.appendChild(s);
    })();
  </script>
</body>
</html>
